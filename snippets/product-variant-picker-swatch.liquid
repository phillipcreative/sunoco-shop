{%- doc -%}
  Renders an isolated variant picker form for bundle products with customizable selection interfaces.

  Creates a self-contained form for selecting and adding product variants to bundles with inventory awareness.

  @param {object} product - Shopify product object with variants and option data
  @param {string} product_id - Unique product identifier for element targeting
  @param {string} section_id - Section identifier for form namespacing
  @param {boolean} [show_variant_labels] - Show variant label
  @param {object} [size_chart] - Shopify page object for size chart
  @param {string} [context] - Context identifier for ID generation
  @param {string} [shopify_attributes] - Shopify-specific attributes
  @param {boolean} [has_jug_import_tag] - Whether product has jug-import tag
  @param {object} [jug_import_collection] - Collection containing jug-import products

  @example
  {% render 'product-variant-picker-swatch',
    product: product,
    product_id: product.id,
    section_id: section.id
  %}
{%- enddoc -%}

<variant-picker id="VariantPicker-{{ section_id }}-{{ product_id }}{% if context == 'bundle' %}-swatch{% endif %}" class="variant-picker grid gap-5{% if context == 'bundle' %} overflow-hidden{% endif %} no-js-hidden" {{ shopify_attributes }}>
  {%- for option in product.options_with_values -%}
    {%- liquid
      assign is_color = false
      assign swatch_trigger_list = 'products.general.color_swatch_trigger' | t | downcase | split: ','
      assign downcased_option = option.name | downcase
      for trigger in swatch_trigger_list
        assign swatch_trigger = trigger | strip
        if downcased_option contains swatch_trigger
          assign is_color = true
        elsif swatch_trigger == 'color' and downcased_option contains 'colour'
          assign is_color = true
        endif

        if is_color == true
          break
        endif
      endfor

      assign is_size = false
      if size_chart != blank
        assign size_trigger = 'products.general.size_trigger' | t | downcase
        assign downcased_option = option.name | downcase
        if downcased_option contains size_trigger
          assign is_size = true
        endif
      endif
    -%}
    <fieldset class="js product-form__input variant-input-wrapper relative"
      data-option-index="option{{ forloop.index }}"
      data-option-slug="{{ option.name | handleize }}"
    >
      <legend class="sr-only">{{ option.name }}</legend>
      <div class="form__label flex items-center justify-between gap-2 w-full">
        {%- if show_variant_labels -%}
          <div class="flex gap-2">
            {{- option.name -}}:
            <span class="font-medium" id="{{ section_id }}-{{ product_id }}-option{{ option.position }}">{{ option.selected_value }}</span>
          </div>
        {%- endif -%}
        {%- if is_size -%}
          <div class="flex items-center gap-2">
            {%- render 'icon', icon: 'ruler', size: 'xs', class: 'stroke-1' -%}
            <button type="button" class="link text-sm leading-tight cursor-pointer" aria-controls="SizeChart-{{ section_id }}-{{ product_id }}" aria-expanded="false">
              {{- 'products.general.size_chart' | t -}}
            </button>
            <x-modal id="SizeChart-{{ section_id }}-{{ product_id }}" class="x-modal drawer z-30 fixed bottom-0 left-0 h-full w-full pointer-events-none"
              role="dialog"
              aria-modal="true"
              aria-label="{{ size_chart.title | escape }}"
              hidden
            >
              <overlay-element class="overlay fixed-modal invisible opacity-0 fixed bottom-0 left-0 w-full h-screen pointer-events-none" aria-controls="SizeChart-{{ section_id }}-{{ product_id }}" aria-expanded="false"></overlay-element>
              <div class="drawer__inner z-10 absolute top-0 flex flex-col w-full h-full overflow-hidden">
                <gesture-element class="drawer__header flex justify-between opacity-0 invisible relative" tabindex="0">
                  <span class="drawer__title heading title-md">{{ size_chart.title | escape }}</span>
                  <button class="button button--secondary button--close drawer__close hidden sm:flex items-center justify-center" type="button" is="hover-button" aria-controls="SizeChart-{{ section_id }}-{{ product_id }}" aria-expanded="false" aria-label="{{ 'general.accessibility.close' | t | escape }}">
                    <span class="btn-fill" data-fill></span>
                    <span class="btn-text">
                      {%- render 'icon', icon: 'close', size: 'sm' -%}
                    </span>
                  </button>
                </gesture-element>
                <div class="drawer__content opacity-0 invisible flex flex-col h-full grow shrink">
                  <div class="drawer__scrollable relative flex flex-col gap-5 md:gap-7 grow shrink">
                    <div class="rte text-base md:text-lg">{{ size_chart.content }}</div>
                  </div>
                </div>
              </div>
            </x-modal>
          </div>
        {%- endif -%}
      </div>
      {%- liquid
        if has_jug_import_tag == blank
          assign has_jug_import_tag = false
          for tag in product.tags
            if tag == 'jug-import'
              assign has_jug_import_tag = true
              break
            endif
          endfor
        endif

        if jug_import_collection == blank and has_jug_import_tag
          if collections.jug-import != blank
            assign jug_import_collection = collections.jug-import
          elsif collections.all != blank
            assign jug_import_collection = collections.all
          endif
        endif
      -%}
      {%- liquid
        assign is_jug_color_option = false
        assign option_name_downcase = option.name | downcase
        if option_name_downcase == 'jug color'
          assign is_jug_color_option = true
        endif
      -%}
      {%- capture swatchs_content -%}
        {%- if has_jug_import_tag and is_color and is_jug_color_option and jug_import_collection != blank -%}
          {%- for all_product in jug_import_collection.products limit: 250 -%}
            {%- liquid
              assign product_has_tag = false
              if jug_import_collection.handle == 'all'
                for product_tag in all_product.tags
                  if product_tag == 'jug-import'
                    assign product_has_tag = true
                    break
                  endif
                endfor
              else
                assign product_has_tag = true
              endif
            -%}
            {%- if product_has_tag -%}
              {%- liquid
                assign related_product = all_product
                assign related_product_color_value = blank
                assign related_product_variant = related_product.selected_or_first_available_variant

                for related_option in related_product.options_with_values
                  assign related_downcased_option = related_option.name | downcase
                  assign related_option_is_color = false
                  for trigger in swatch_trigger_list
                    assign swatch_trigger = trigger | strip
                    if related_downcased_option contains swatch_trigger
                      assign related_option_is_color = true
                      break
                    elsif swatch_trigger == 'color' and related_downcased_option contains 'colour'
                      assign related_option_is_color = true
                      break
                    endif
                  endfor

                  if related_option_is_color
                    assign related_product_color_value = related_option.selected_value
                    break
                  endif
                endfor

                if related_product_color_value == blank
                  for related_option in related_product.options_with_values
                    assign related_option_index_0 = forloop.index0
                    assign related_option_is_color = false
                    assign related_downcased_option = related_option.name | downcase
                    for trigger in swatch_trigger_list
                      assign swatch_trigger = trigger | strip
                      if related_downcased_option contains swatch_trigger
                        assign related_option_is_color = true
                        break
                      elsif swatch_trigger == 'color' and related_downcased_option contains 'colour'
                        assign related_option_is_color = true
                        break
                      endif
                    endfor

                    if related_option_is_color
                      for related_variant in related_product.variants
                        assign related_variant_value = related_variant.options[related_option_index_0]
                        if related_variant_value != blank
                          assign related_product_color_value = related_variant_value
                          break
                        endif
                      endfor
                      if related_product_color_value != blank
                        break
                      endif
                    endif
                  endfor
                endif

                assign swatch_image = blank
                assign swatch_fallback = blank
                assign swatch_fallback_override = false

                if related_product_variant.image
                  assign swatch_image = related_product_variant.image | image_url: width: 72
                  assign swatch_fallback_override = false
                elsif related_product.featured_media
                  assign swatch_image = related_product.featured_media | image_url: width: 72
                  assign swatch_fallback_override = false
                else
                  assign file_extension = 'png'
                  assign file_name = related_product_color_value | handle | append: '.' | append: file_extension
                  assign swatch_fallback = related_product_color_value | split: ' ' | last | handle

                  if settings.swatch_config != blank
                    assign value_downcase = related_product_color_value | downcase
                    assign swatch_config = settings.swatch_config | newline_to_br | split: '<br />'
                    for swatch in swatch_config
                      assign swatch_parts = swatch | strip | split: ':'
                      assign swatch_name = swatch_parts.first | downcase | strip

                      if swatch_name == value_downcase
                        assign swatch_value = swatch_parts.last | strip
                        if swatch_value contains '#'
                          assign swatch_fallback = swatch_value
                          assign swatch_fallback_override = true
                        else
                          assign file_name = swatch_value
                        endif
                        break
                      endif
                    endfor
                  endif

                  if images[file_name] != blank
                    assign swatch_image = images[file_name] | image_url: width: 72
                  elsif file_name contains '//cdn.shopify.com/'
                    assign swatch_image = file_name
                  endif
                endif

                assign matching_variant = blank
                for variant_option in related_product.options_with_values
                  assign variant_option_index_0 = forloop.index0
                  assign variant_option_is_color = false
                  assign variant_option_downcase = variant_option.name | downcase
                  for trigger in swatch_trigger_list
                    assign swatch_trigger = trigger | strip
                    if variant_option_downcase contains swatch_trigger
                      assign variant_option_is_color = true
                      break
                    elsif swatch_trigger == 'color' and variant_option_downcase contains 'colour'
                      assign variant_option_is_color = true
                      break
                    endif
                  endfor

                  if variant_option_is_color
                    for variant_check in related_product.variants
                      assign variant_check_value = variant_check.options[variant_option_index_0]
                      if variant_check_value == related_product_color_value
                        assign matching_variant = variant_check
                        break
                      endif
                    endfor
                    if matching_variant != blank
                      break
                    endif
                  endif
                endfor

                if matching_variant == blank
                  assign matching_variant = related_product_variant
                endif

                assign is_current_product = false
                assign is_selected = false
                if related_product.id == product.id
                  assign is_current_product = true
                  if matching_variant.id == product.selected_or_first_available_variant.id
                    assign is_selected = true
                  endif
                endif

                assign input_id = section_id | append: '-' | append: product_id | append: '-' | append: option.name | handle | append: '-' | append: related_product.id
              -%}
            <li>
              <magnet-element class="block" data-magnet="0">
                {%- if is_current_product -%}
                  <input
                    type="radio"
                    class="sr-only{% unless related_product_variant.available %} disabled{% endunless %}"
                    id="{{ input_id }}"
                    name="{{ option.name }}-{{ section_id }}-{{ product_id }}"
                    value="{{ related_product_color_value | escape }}"
                    {% if is_selected %}checked{% endif %}
                    data-option-value="{{ related_product_color_value | escape }}"
                    align-selected=".scroll-area"
                  />
                {%- endif -%}
                <a
                  href="{{ related_product.url }}"
                  class="color-swatch{% if swatch_image != blank %} with-image{% endif %} block relative{% if is_current_product %} cursor-pointer{% endif %}{% if is_current_product and is_selected %} active{% endif %}"
                  title="{{ related_product_color_value | escape }}"
                  style="--swatch-background: {{ swatch_fallback }};{% if swatch_fallback_override == false and swatch_image != blank %}--swatch-background-image: url({{ swatch_image }});{% endif %}"
                  {% if is_current_product %}onclick="event.preventDefault(); document.getElementById('{{ input_id }}').click();"{% endif %}
                >
                  <span class="sr-only">{{ related_product_color_value | escape }}</span>
                  {%- unless context == 'bundle' -%}
                    <span class="tooltip opacity-0 pointer-events-none text-xs rounded-full z-10">{{ related_product_color_value | escape }}</span>
                  {%- endunless -%}
                </a>
              </magnet-element>
            </li>
            {%- endif -%}
          {%- endfor -%}
        {%- else -%}
          {%- for value in option.values -%}
          <li>
            <magnet-element class="block" data-magnet="0">
              <input
                type="radio"
                class="sr-only{% unless value.available %} disabled{% endunless %}"
                id="{{ section_id }}-{{ product_id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                name="{{ option.name }}-{{ section_id }}-{{ product_id }}"
                value="{{ value | escape }}"
                {% if option.selected_value == value %}checked{% endif %}
                {% if value.product_url != blank and value.product_url != product.url %}data-product-url="{{ value.variant.url | default: value.product_url }}"{% endif %}
                data-option-value="{{ value | escape }}"
                data-option-value-id="{{ value.id }}"
                align-selected=".scroll-area"
              />
              {%- if is_color or value.swatch != blank -%}
                {%- liquid
                  if value.swatch == blank
                    assign file_extension = 'png'
                    assign file_name = value | handle | append: '.' | append: file_extension
                    assign swatch_fallback = value | split: ' ' | last | handle
                    assign swatch_fallback_override = false

                    if settings.swatch_config != blank
                      assign value_downcase = value | downcase
                      assign swatch_config = settings.swatch_config | newline_to_br | split: '<br />'
                      for swatch in swatch_config
                        assign swatch_parts = swatch | strip | split: ':'
                        assign swatch_name = swatch_parts.first | downcase | strip

                        if swatch_name == value_downcase
                          assign swatch_value = swatch_parts.last | strip
                          if swatch_value contains '#'
                            assign swatch_fallback = swatch_value
                            assign swatch_fallback_override = true
                          else
                            assign file_name = swatch_value
                          endif
                          break
                        endif
                      endfor
                    endif

                    assign swatch_image = blank
                    if images[file_name] != blank
                      assign swatch_image = images[file_name] | image_url: width: 72
                    elsif file_name contains '//cdn.shopify.com/'
                      assign swatch_image = file_name
                    endif
                  else
                    assign swatch_image = blank
                    assign swatch_fallback = value | split: ' ' | last | handle
                    if value.swatch.image
                      assign swatch_image = value.swatch.image | image_url: width: 72
                      assign swatch_fallback_override = false
                    elsif value.swatch.color
                      assign swatch_fallback = value.swatch.color
                    endif
                  endif
                -%}
                <label
                  for="{{ section_id }}-{{ product_id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                  class="color-swatch{% if swatch_image != blank %} with-image{% endif %} cursor-pointer block relative"
                  title="{{ value | escape }}"
                  style="--swatch-background: {{ swatch_fallback }};{% if swatch_fallback_override == false and swatch_image != blank %}--swatch-background-image: url({{ swatch_image }});{% endif %}"
                >
                  <span class="sr-only">{{ value | escape }}</span>
                  {%- unless context == 'bundle' -%}
                    <span class="tooltip opacity-0 pointer-events-none text-xs rounded-full z-10">{{ value | escape }}</span>
                  {%- endunless -%}
                </label>
              {%- else -%}
                <label
                  for="{{ section_id }}-{{ product_id }}-{{ option.name | handle }}-{{ forloop.index0 }}"
                  class="label-swatch text-sm font-medium leading-none cursor-pointer block relative"
                  title="{{ value | escape }}"
                >
                  {{- value -}}
                </label>
              {%- endif -%}
            </magnet-element>
          </li>
        {%- endfor -%}
        {%- endif -%}
      {%- endcapture -%}
      {%- if context == 'bundle' -%}
        <scroll-shadow class="product-card__bottom grid overflow-hidden">
          <ul class="scroll-area swatches swatches--{{ settings.rounded_swatch }} grid justify-start gap-4">
            {{- swatchs_content -}}
          </ul>
          <template>
            <slot></slot>
            <s dir="{% render 'direction' %}" style="--t: 0;--b: 0;--l: 0;--r: 0;">
              <span class="l"></span>
              <span class="r"></span>
            </s>
            <style>
              :host{display:inline-block;position:relative}:host([hidden]){display:none}
              s{position:absolute;inset:0;pointer-events:none;{% if settings.card_style == 'card' %}--color-background:var(--color-placeholder){% endif %}}
              s span{position:absolute;inset-block:0;width:var(--sp-12);opacity:0;transition:opacity var(--animation-short);}
              s .l{inset-inline-start:0;opacity:var(--l);background:linear-gradient(90deg,rgb(var(--color-background)) 0%,transparent 100%);}
              s .r{inset-inline-end:0;opacity:var(--r);background:linear-gradient(270deg,rgb(var(--color-background)) 0%,transparent 100%);}
              s[dir=rtl] :is(.icon-chevron-left,.icon-chevron-right){transform:scaleX(-1);}
            </style>
          </template>
        </scroll-shadow>
      {%- else -%}
        <ul class="swatches swatches--{{ settings.rounded_swatch }} flex items-start flex-wrap gap-4">
          {{- swatchs_content -}}
        </ul>
      {%- endif -%}
    </fieldset>
  {%- endfor -%}

  <script type="application/json" data-selected-variant>{{ product.selected_or_first_available_variant | json }}</script>
</variant-picker>
