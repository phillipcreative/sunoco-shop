<style>
  #shopify-section-{{ section.id }} {
    --section-padding-top: {{ section.settings.padding_top }}px;
    --section-padding-bottom: {{ section.settings.padding_bottom }}px;
    margin-top: {{ section.settings.margin_top }}px;
    margin-bottom: {{ section.settings.margin_bottom }}px;
    {%- render 'section-variables', section: section -%}
  }

  @media screen and (min-width: 1024px) {
    .ml-featured-product__container {
      grid-template-columns: 1fr {{ section.settings.featured_image_width }}px;
      gap: 60px;
    }
  }
</style>


{%- liquid
  assign product = section.settings.product
  if product != blank
    assign product_form_id = 'MLProductForm-' | append: section.id | append: '-' | append: product.id
    assign media_count = product.media.size
    assign product_variant = product.selected_or_first_available_variant
    assign featured_media = product_variant.featured_media | default: product.featured_media | default: product.media.first
  endif
-%}

{%- if product.quantity_price_breaks_configured? -%}
  {{ 'volume-pricing.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'volume-pricing.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

<div class="ml-featured-product section section--padding page-width{% if section.settings.divider %} section--divider{% endif %}{% if section.settings.rounded %} section--rounded relative{% endif %}">
  <div class="relative">
    {%- if product != blank -%}
      <div class="ml-featured-product__container">
        <div class="ml-featured-product__content-wrapper">
          <div class="ml-featured-product__gallery">
          {%- if media_count > 0 -%}
            {%- liquid
              assign variant_images = product.images | where: 'attached_to_variant?', true | map: 'src'
              assign sizes = '(max-width: 740px) calc(100vw - 40px), (max-width: 999px) calc(100vw - 64px), min(580px, 30vw)'
            -%}
            <media-gallery id="MLProductGallery-{{ section.id }}-{{ product.id }}" class="product__gallery product__gallery--thumbnail block w-full relative" form="{{ product_form_id }}" aria-label="{{ 'products.media.gallery_viewer' | t | escape }}">
              <div class="product__media-container flex flex-col gap-4">
                <div class="relative w-full h-full">
                  <slider-element id="MLSliderGallery-{{ section.id }}-{{ product.id }}" class="slider slider--desktop slider--tablet block w-full h-full" selector=".product__media" tabindex="0">
                    <div class="product__media-list flex gap-1">
                      {%- if featured_media != null -%}
                        {%- render 'product-media',
                          product: product,
                          product_id: product.id,
                          section_id: section.id,
                          product_variant: product_variant,
                          media: featured_media,
                          featured_media: featured_media,
                          variant_images: variant_images,
                          hide_variants: false,
                          gallery_layout: 'thumbnail',
                          image_zoom: 'none',
                          image_fill: settings.product_image_fill,
                          image_ratio: 'adapt',
                          image_ratio_mobile: 'adapt',
                          preload: true,
                          sizes: sizes,
                          autoplay: false,
                          loop: false
                        -%}
                      {%- endif -%}

                      {%- for media in product.media -%}
                        {%- if media.id != featured_media.id -%}
                          {%- render 'product-media',
                            product: product,
                            product_id: product.id,
                            section_id: section.id,
                            product_variant: product_variant,
                            media: media,
                            featured_media: featured_media,
                            variant_images: variant_images,
                            hide_variants: false,
                            gallery_layout: 'thumbnail',
                            image_zoom: 'none',
                            image_fill: settings.product_image_fill,
                            image_ratio: 'adapt',
                            image_ratio_mobile: 'adapt',
                            preload: false,
                            sizes: sizes,
                            autoplay: false,
                            loop: false
                          -%}
                        {%- endif -%}
                      {%- endfor -%}
                    </div>
                  </slider-element>

                  <div class="indicators flex gap-2d5 items-center !justify-between absolute top-0 left-0 w-full h-full pointer-events-none">
                    <button class="button button--secondary pointer-events-auto" type="button" is="previous-button" aria-controls="MLSliderGallery-{{ section.id }}-{{ product.id }}" aria-label="{{ 'general.pagination.previous' | t | escape }}" disabled data-button="previous">
                      <span class="btn-fill" data-fill></span>
                      <span class="btn-text">
                        {%- render 'icon', icon: 'chevron-left', class: 'transform' -%}
                      </span>
                    </button>
                    <button class="button button--secondary pointer-events-auto" type="button" is="next-button" aria-controls="MLSliderGallery-{{ section.id }}-{{ product.id }}" aria-label="{{ 'general.pagination.next' | t | escape }}" data-button="next">
                      <span class="btn-fill" data-fill></span>
                      <span class="btn-text">
                        {%- render 'icon', icon: 'chevron-right', class: 'transform' -%}
                      </span>
                    </button>
                  </div>
                </div>

                {%- if media_count > 1 -%}
                  <scroll-shadow id="MLThumbnails-{{ section.id }}-{{ product.id }}" class="product__thumbnails product__thumbnails--below grid items-center relative w-full">
                    <media-dots class="product__thumbnails-list scroll-area grid items-end justify-start gap-1 w-full" aria-controls="MLSliderGallery-{{ section.id }}-{{ product.id }}">
                      {%- if featured_media != null -%}
                        {%- render 'product-thumbnail',
                          product: product,
                          product_variant: product_variant,
                          media: featured_media,
                          featured_media: featured_media,
                          variant_images: variant_images,
                          hide_variants: false,
                          image_fill: settings.product_image_fill,
                          image_ratio: 'adapt',
                          image_ratio_mobile: 'adapt',
                          position: 0
                        -%}
                      {%- endif -%}

                      {%- for media in product.media -%}
                        {%- if media.id != featured_media.id -%}
                          {%- render 'product-thumbnail',
                            product: product,
                            product_variant: product_variant,
                            media: media,
                            featured_media: featured_media,
                            variant_images: variant_images,
                            hide_variants: false,
                            image_fill: settings.product_image_fill,
                            image_ratio: 'adapt',
                            image_ratio_mobile: 'adapt',
                            position: forloop.index
                          -%}
                        {%- endif -%}
                      {%- endfor -%}
                    </media-dots>
                    <template>
                      <slot></slot>
                      <s dir="{% render 'direction' %}" style="--t: 0;--b: 0;--l: 0;--r: 0;">
                        <span class="t">{%- render 'icon', icon: 'chevron-up' -%}</span>
                        <span class="b">{%- render 'icon', icon: 'chevron-down' -%}</span>
                        <span class="l">{%- render 'icon', icon: 'chevron-left' -%}</span>
                        <span class="r">{%- render 'icon', icon: 'chevron-right' -%}</span>
                      </s>
                      <style>
                        :host{display:inline-block;position:relative}:host([hidden]){display:none}
                        s{position:absolute;inset:0;pointer-events:none;display:none;}
                        s svg{width:24px;height:auto;stroke-width:var(--icon-weight);}
                        s span{position:absolute;display:grid;align-items:center;justify-items:center;background-color:rgb(var(--color-background));padding:8px;opacity:0;transition:opacity var(--animation-short);}
                        s .t{inset-block-start:0;inset-inline:-5px;border-block-end:1px solid rgb(var(--color-border));opacity:var(--t);}
                        s .b{inset-block-end:0;inset-inline:-5px;border-block-start:1px solid rgb(var(--color-border));opacity:var(--b);}
                        s .l{inset-inline-start:0;inset-block:-5px;border-inline-end:1px solid rgb(var(--color-border));opacity:var(--l);}
                        s .r{inset-inline-end:0;inset-block:-5px;border-inline-start:1px solid rgb(var(--color-border));opacity:var(--r);}
                        s[dir=rtl] :is(.icon-chevron-left,.icon-chevron-right){transform:scaleX(-1);}
                        @media screen and (max-width: 1023px) {
                          s{display:none}
                        }
                      </style>
                    </template>
                  </scroll-shadow>
                {%- endif -%}
              </div>
            </media-gallery>
          {%- else -%}
            <div class="ml-featured-product__main-image">
              {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          {%- endif -%}
          </div>

          <div class="ml-featured-product__info">
          <h2 class="ml-featured-product__title">{{ product.title }}</h2>

          <div class="ml-featured-product__price">
            {%- liquid
              if settings.currency_code_enabled
                echo product.selected_or_first_available_variant.price | money_with_currency
              else
                echo product.selected_or_first_available_variant.price | money
              endif
            -%}
          </div>

          {%- if product.description != blank -%}
            <div class="ml-featured-product__description rte">
              {{ product.description }}
            </div>
          {%- endif -%}

          {%- form 'product', product, id: product_form_id, class: 'ml-featured-product__form', is: 'product-form' -%}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" disabled />

            {%- unless product.has_only_default_variant -%}
              <div class="ml-featured-product__variant-selector">
                {%- for option in product.options_with_values -%}
                  <div class="ml-featured-product__variant-option">
                    <label class="ml-featured-product__variant-label">
                      Select {{ option.name }}:
                      <span class="ml-featured-product__variant-selected">{{ option.selected_value }}</span>
                    </label>
                    <div class="ml-featured-product__variant-values">
                      {%- for value in option.values -%}
                        {%- assign variant_available = false -%}
                        {%- assign variant_id = null -%}
                        {%- assign option_index = forloop.parentloop.index0 -%}

                        {%- for variant in product.variants -%}
                          {%- if variant.options[option_index] == value -%}
                            {%- if variant.available -%}
                              {%- assign variant_available = true -%}
                              {%- assign variant_id = variant.id -%}
                              {%- break -%}
                            {%- elsif variant_id == null -%}
                              {%- assign variant_id = variant.id -%}
                            {%- endif -%}
                          {%- endif -%}
                        {%- endfor -%}

                        {%- assign is_selected = false -%}
                        {%- if product.selected_or_first_available_variant.options[option_index] == value -%}
                          {%- assign is_selected = true -%}
                        {%- endif -%}

                        {% assign option_name_downcase = option.name | downcase %}
                        {% if option_name_downcase == 'color' or option_name_downcase == 'colour' %}
                          {% assign is_color_option = true %}
                        {% else %}
                          {% assign is_color_option = false %}
                        {% endif %}
                        {% assign swatch = value.swatch %}
                        {% assign swatch_color = swatch.color %}

                        <button
                          style="background-color: {{ swatch_color }};"
                          type="button"
                          class="ml-featured-product__variant-value{% if is_selected %} selected{% endif %}{% unless variant_available %} unavailable{% endunless %}{% if is_color_option %} is-swatch{% endif %}"
                          data-option-index="{{ option_index }}"
                          data-option-value="{{ value | escape }}"
                          {% if variant_id %}data-variant-id="{{ variant_id }}"{% endif %}
                          {% unless variant_available %}disabled{% endunless %}
                          {% if is_color_option %}aria-label="{{ value | escape }}"{% endif %}
                        >
                          {% if is_color_option and swatch != blank %}
                            {% if swatch.image != blank %}
                              <img
                                class="ml-featured-product__swatch-image"
                                src="{{ swatch.image | image_url: width: 64 }}"
                                alt="{{ value | escape }}"
                                loading="lazy"
                              >
                            {% elsif swatch.color != blank %}
                              <span
                                class="ml-featured-product__swatch-color"
                                style="background-color: {{ swatch.color }};"
                              ></span>
                            {% else %}
                              {{ value }}
                            {% endif %}
                          {% else %}
                            {{ value }}
                          {% endif %}
                        </button>

                      {%- endfor -%}
                    </div>

                  </div>
                {%- endfor -%}
              </div>
            {%- endunless -%}

            <div class="ml-featured-product__quantity-cart">
              {%- assign cart_qty = cart | item_count_for_variant: product.selected_or_first_available_variant.id -%}
              <quantity-input class="ml-featured-product__quantity inline-flex relative" data-section-id="{{ section.id }}" data-product-id="{{ product.id }}">
                <button type="button" name="minus" class="ml-featured-product__quantity-button" aria-label="{{ 'products.quantity.decrease' | t: product: product.title | escape }}">
                  {%- render 'icon', icon: 'chevron-left', size: 'sm', class: 'stroke-2 transform' -%}
                </button>
                <input
                  type="number"
                  name="quantity"
                  id="MLQuantity-{{ section.id }}-{{ product.id }}"
                  class="ml-featured-product__quantity-input"
                  inputmode="numeric"
                  autocomplete="off"
                  data-quantity-variant-id="{{ product.selected_or_first_available_variant.id }}"
                  data-cart-quantity="{{ cart_qty }}"
                  data-min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                  min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                  {% if product.selected_or_first_available_variant.quantity_rule.max != null %}
                    data-max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                    max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                  {% endif %}
                  step="{{ product.selected_or_first_available_variant.quantity_rule.increment }}"
                  value="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                  form="{{ product_form_id }}"
                />
                <button type="button" name="plus" class="ml-featured-product__quantity-button" aria-label="{{ 'products.quantity.increase' | t: product: product.title | escape }}">
                  {%- render 'icon', icon: 'chevron-right', size: 'sm', class: 'stroke-2 transform' -%}
                </button>
              </quantity-input>
              <button
                type="submit"
                name="add"
                form="{{ product_form_id }}"
                class="button ml-featured-product__add-to-cart"
                is="hover-button"
                {%- if product.selected_or_first_available_variant.available == false %} disabled{% endif -%}
              >
                <span class="btn-fill" data-fill></span>
                <span class="btn-text">
                  {%- liquid
                    if product.selected_or_first_available_variant.available == false
                      echo 'products.product.sold_out' | t
                    else
                      echo 'products.product.add_to_cart' | t
                    endif
                  -%}
                </span>
              </button>
            </div>
          {%- endform -%}

          {% comment %} <a href="{{ product.url }}" class="ml-featured-product__view-product-link">View More {% render 'icon', icon: 'arrow-right', class: 'transform' %}</a> {% endcomment %}

          </div>
        </div>

        {%- if section.settings.featured_image != blank -%}
          {%- if section.settings.featured_image_link != blank -%}
            <a href="{{ section.settings.featured_image_link }}" class="ml-featured-product__featured-image" aria-label="{{ section.settings.featured_image_text | default: 'Featured image' | escape }}">
          {%- else -%}
            <div class="ml-featured-product__featured-image">
          {%- endif -%}
            {{- section.settings.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', sizes: '300px', widths: '300,600,900', alt: section.settings.featured_image_text, is: 'lazy-image', class: 'w-full h-full object-cover' -}}
            {%- if section.settings.featured_image_text != blank -%}
              <div class="ml-featured-product__featured-image-content">
                <div class="ml-featured-product__featured-image-text">
                  {{ section.settings.featured_image_text | escape }}
                  {%- render 'icon', icon: 'arrow-right', class: 'transform' -%}
                </div>
              </div>
            {%- endif -%}
          {%- if section.settings.featured_image_link != blank -%}
            </a>
          {%- else -%}
            </div>
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- else -%}
      <div class="ml-featured-product__container">
        <div class="ml-featured-product__content-wrapper">
          <div class="ml-featured-product__gallery">
            <div class="ml-featured-product__main-image">
              {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          </div>
          <div class="ml-featured-product__info">
            <h2 class="ml-featured-product__title">{{ 'sections.featured_product.title' | t }}</h2>
            <p>{{ 'sections.featured_product.no_product' | t }}</p>
          </div>
        </div>
      </div>
    {%- endif -%}
  </div>
</div>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const productId = '{{ product.id }}';
    const formId = 'MLProductForm-' + sectionId + '-' + productId;
    const galleryId = 'MLSliderGallery-' + sectionId + '-' + productId;
    const thumbnailsId = 'MLThumbnails-' + sectionId + '-' + productId;
    const mediaGalleryId = 'MLProductGallery-' + sectionId + '-' + productId;

    {%- if product != blank -%}
    const productData = {{ product | json }};
    const form = document.getElementById(formId);
    const gallery = document.getElementById(galleryId);
    const thumbnails = document.getElementById(thumbnailsId);
    const mediaGallery = document.getElementById(mediaGalleryId);
    const featuredMediaId = {% if featured_media != blank %}{{ featured_media.id }}{% else %}null{% endif %};

    // Initialize PhotoSwipe lightbox for image zoom
    function initPhotoSwipe() {
      if (!mediaGallery || typeof PhotoSwipeLightbox === 'undefined' || typeof theme === 'undefined' || !theme.settings) {
        return;
      }

      let photoswipeLightbox = null;
      photoswipeLightbox = new PhotoSwipeLightbox({
        arrowPrevSVG: '<svg class="pswp__icn icon" stroke="currentColor" fill="none" viewBox="0 0 30 30"><path d="M17.5 7.5L10 15L17.5 22.5"/></svg>',
        arrowNextSVG: '<svg class="pswp__icn icon" stroke="currentColor" fill="none" viewBox="0 0 30 30"><path d="M17.5 7.5L10 15L17.5 22.5"/></svg>',
        closeSVG: '<svg class="pswp__icn icon" stroke="currentColor" fill="none" viewBox="0 0 30 30"><path d="m7.5 22.5 15-15m-15 0 15 15"/></svg>',
        bgOpacity: 1,
        pswpModule: () => import(theme.settings.pswpModule),
        arrowPrevTitle: theme.strings ? theme.strings.previous : 'Previous',
        arrowNextTitle: theme.strings ? theme.strings.next : 'Next',
        closeTitle: theme.strings ? theme.strings.close : 'Close',
        allowPanToNext: false,
        allowMouseDrag: true,
        wheelToZoom: false,
        returnFocus: true,
        zoom: false,
      });

      photoswipeLightbox.addFilter('thumbEl', (_thumbEl, data) => data['thumbnailElement']);
      photoswipeLightbox.init();

      // Add click handlers to media items
      const mediaItems = gallery.querySelectorAll('.product__media');
      mediaItems.forEach(function(item, index) {
        if (item.getAttribute('data-media-type') === 'image') {
          item.style.cursor = 'pointer';
          item.addEventListener('click', function() {
            const dataSource = Array.from(mediaItems).map(function(media) {
              const image = media.querySelector('img');
              if (image && media.getAttribute('data-media-type') === 'image') {
                return {
                  thumbnailElement: image,
                  src: image.src,
                  srcset: image.srcset || '',
                  msrc: image.currentSrc || image.src,
                  width: parseInt(image.getAttribute('width')) || image.naturalWidth || 1200,
                  height: parseInt(image.getAttribute('height')) || image.naturalHeight || 1200,
                  alt: image.alt || '',
                  thumbCropped: true
                };
              }
              return null;
            }).filter(function(item) { return item !== null; });

            if (photoswipeLightbox && dataSource.length > 0) {
              photoswipeLightbox.loadAndOpen(index, dataSource);
            }
          });
        }
      });
    }

    // Wait for PhotoSwipe to be available
    if (typeof PhotoSwipeLightbox === 'undefined') {
      // Try to initialize after a short delay
      setTimeout(initPhotoSwipe, 500);
    } else {
      initPhotoSwipe();
    }

    // Sync active class on thumbnails
    function syncThumbnailActiveClass() {
      if (!thumbnails) return;

      const thumbnailElements = thumbnails.querySelectorAll('.product__thumbnail');
      thumbnailElements.forEach(function(thumbnail) {
        if (thumbnail.getAttribute('aria-current') === 'true') {
          thumbnail.classList.add('active');
        } else {
          thumbnail.classList.remove('active');
        }
      });
    }

    // Watch for changes to thumbnail active state
    if (thumbnails) {
      const thumbnailList = thumbnails.querySelector('.product__thumbnails-list');
      if (thumbnailList) {
        // Initial sync
        syncThumbnailActiveClass();

        // Watch for aria-current changes
        const observer = new MutationObserver(function(mutations) {
          mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'aria-current') {
              syncThumbnailActiveClass();
            }
          });
        });

        const thumbnailElements = thumbnailList.querySelectorAll('.product__thumbnail');
        thumbnailElements.forEach(function(thumbnail) {
          observer.observe(thumbnail, {
            attributes: true,
            attributeFilter: ['aria-current']
          });
        });

        // Also listen to slider scroll events to sync
        if (gallery) {
          gallery.addEventListener('scroll', function() {
            setTimeout(syncThumbnailActiveClass, 50);
          });
        }
      }
    }

    // Use theme.js gallery functionality with manual scroll fallback
    if (gallery) {
      function manualScroll(direction) {
        if (gallery.itemsToShow && gallery.itemsToShow.length > 1) {
          const firstItem = gallery.itemsToShow[0];
          const secondItem = gallery.itemsToShow[1];
          const itemWidth = firstItem.clientWidth || firstItem.offsetWidth;
          const gap = secondItem.offsetLeft - (firstItem.offsetLeft + itemWidth);
          const scrollAmount = itemWidth + gap;
          const currentScroll = gallery.scrollLeft;
          const newScrollPosition = direction === 'next'
            ? currentScroll + scrollAmount
            : Math.max(0, currentScroll - scrollAmount);

          gallery.scrollTo({
            left: newScrollPosition,
            behavior: 'smooth'
          });
        }
      }

      // Find buttons and add direct click handlers
      const prevButton = document.querySelector('[aria-controls="' + galleryId + '"][data-button="previous"]');
      const nextButton = document.querySelector('[aria-controls="' + galleryId + '"][data-button="next"]');

      if (prevButton) {
        prevButton.addEventListener('click', function(e) {
          // Try the built-in method first
          if (gallery && typeof gallery.previous === 'function') {
            const scrollBefore = gallery.scrollLeft;
            gallery.previous();

            // Check if it actually scrolled after a short delay
            setTimeout(function() {
              if (gallery.scrollLeft === scrollBefore || gallery.itemOffset === 0 || isNaN(gallery.perPage)) {
                manualScroll('previous');
              }
            }, 150);
          } else {
            manualScroll('previous');
          }
        });
      }

      if (nextButton) {
        nextButton.addEventListener('click', function(e) {
          // Try the built-in method first
          if (gallery && typeof gallery.next === 'function') {
            const scrollBefore = gallery.scrollLeft;
            gallery.next();

            // Check if it actually scrolled after a short delay
            setTimeout(function() {
              if (gallery.scrollLeft === scrollBefore || gallery.itemOffset === 0 || isNaN(gallery.perPage)) {
                manualScroll('next');
              }
            }, 150);
          } else {
            manualScroll('next');
          }
        });
      }

      // Also listen for slider events as backup
      gallery.addEventListener('slider:previous', function(e) {
        const scrollBefore = gallery.scrollLeft;
        setTimeout(function() {
          if (gallery.scrollLeft === scrollBefore && (gallery.itemOffset === 0 || isNaN(gallery.perPage))) {
            manualScroll('previous');
          }
        }, 100);
      });

      gallery.addEventListener('slider:next', function(e) {
        const scrollBefore = gallery.scrollLeft;
        setTimeout(function() {
          if (gallery.scrollLeft === scrollBefore && (gallery.itemOffset === 0 || isNaN(gallery.perPage))) {
            manualScroll('next');
          }
        }, 100);
      });
    }

    // Variant selection and add to cart functionality
    (function() {
      if (!form) return;

      const variantInput = form.querySelector('input[name="id"]');
      const variantButtons = form.querySelectorAll('.ml-featured-product__variant-value');
      const addToCartButton = form.querySelector('.ml-featured-product__add-to-cart');
      const priceElement = document.querySelector('.ml-featured-product__price');
      const quantityInput = form.querySelector('input[name="quantity"]');

      let selectedVariant = null;
      const productVariants = productData.variants || [];

      // Find variant by selected options
      function findVariantByOptions(selectedOptions) {
        return productVariants.find(function(variant) {
          return variant.options.every(function(option, index) {
            return String(option).trim().toLowerCase() === String(selectedOptions[index]).trim().toLowerCase();
          });
        });
      }

      // Get currently selected options
      function getSelectedOptions() {
        const selectedOptions = [];
        const optionGroups = form.querySelectorAll('.ml-featured-product__variant-option');

        optionGroups.forEach(function(optionGroup) {
          const selectedButton = optionGroup.querySelector('.ml-featured-product__variant-value.selected');
          if (selectedButton) {
            selectedOptions.push(selectedButton.getAttribute('data-option-value'));
          }
        });

        return selectedOptions;
      }

      // Update variant selection
      function updateVariantSelection() {
        const selectedOptions = getSelectedOptions();
        const optionGroups = form.querySelectorAll('.ml-featured-product__variant-option');
        const totalOptions = optionGroups.length;

        // Handle products with only default variant
        if (productData.has_only_default_variant || totalOptions === 0) {
          selectedVariant = productVariants[0] || null;
        } else if (selectedOptions.length === totalOptions) {
          // Find variant that matches all selected options
          selectedVariant = findVariantByOptions(selectedOptions);
        } else {
          // Clear selected variant if not all options are selected
          selectedVariant = null;
        }

        if (selectedVariant) {
          variantInput.value = selectedVariant.id;
          variantInput.removeAttribute('disabled');

          // Update price
          if (priceElement && typeof theme !== 'undefined' && theme.Currency) {
            const priceFormat = theme.settings.currencyCodeEnabled
              ? theme.settings.moneyWithCurrencyFormat
              : theme.settings.moneyFormat;
            priceElement.textContent = theme.Currency.formatMoney(selectedVariant.price, priceFormat);
          }

          // Update add to cart button
          if (addToCartButton && typeof theme !== 'undefined' && theme.variantStrings) {
            const buttonText = addToCartButton.querySelector('.btn-text');
            if (buttonText) {
              if (selectedVariant.available) {
                buttonText.textContent = theme.variantStrings.addToCart;
                addToCartButton.removeAttribute('disabled');
              } else {
                buttonText.textContent = theme.variantStrings.soldOut;
                addToCartButton.setAttribute('disabled', 'disabled');
              }
            }
          }

          // Update quantity input
          if (quantityInput) {
            quantityInput.setAttribute('data-quantity-variant-id', selectedVariant.id);
            if (selectedVariant.quantity_rule) {
              quantityInput.setAttribute('data-min', selectedVariant.quantity_rule.min || 1);
              quantityInput.setAttribute('min', selectedVariant.quantity_rule.min || 1);
              if (selectedVariant.quantity_rule.max) {
                quantityInput.setAttribute('data-max', selectedVariant.quantity_rule.max);
                quantityInput.setAttribute('max', selectedVariant.quantity_rule.max);
              } else {
                quantityInput.removeAttribute('data-max');
                quantityInput.removeAttribute('max');
              }
              quantityInput.setAttribute('step', selectedVariant.quantity_rule.increment || 1);
            }
          }
        }
      }

      // Handle variant button clicks
      variantButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          if (button.hasAttribute('disabled')) return;

          const optionIndex = parseInt(button.getAttribute('data-option-index'));
          const optionValue = button.getAttribute('data-option-value');
          const optionGroup = button.closest('.ml-featured-product__variant-option');

          // Remove selected class from all buttons in this option group
          optionGroup.querySelectorAll('.ml-featured-product__variant-value').forEach(function(btn) {
            btn.classList.remove('selected');
          });

          // Add selected class to clicked button
          button.classList.add('selected');

          // Update selected value display
          const selectedSpan = optionGroup.querySelector('.ml-featured-product__variant-selected');
          if (selectedSpan) {
            selectedSpan.textContent = optionValue;
          }

          // Update variant selection
          updateVariantSelection();
        });
      });

      // Handle form submission with fetch
      form.addEventListener('submit', function(event) {
        event.preventDefault();

        if (addToCartButton.hasAttribute('aria-disabled')) {
          return;
        }

        // Find the active swatch's data-variant-id
        const selectedSwatch = form.querySelector('.ml-featured-product__variant-value.selected.is-swatch');
        let variantId = null;

        if (selectedSwatch) {
          const variantIdAttr = selectedSwatch.getAttribute('data-variant-id');
          if (variantIdAttr) {
            variantId = parseInt(variantIdAttr);
          }
        }

        // Fallback: use variant input value if available
        if (!variantId && variantInput && variantInput.value) {
          variantId = parseInt(variantInput.value);
        }

        if (!variantId) {
          return;
        }

        const quantity = parseInt(quantityInput.value) || 1;

        // Set loading state
        addToCartButton.setAttribute('aria-disabled', 'true');
        addToCartButton.setAttribute('aria-busy', 'true');

        // Get sections to include in request
        let sectionsToBundle = [];
        const cartDrawer = document.querySelector('cart-drawer');
        if (cartDrawer) {
          const sectionId = cartDrawer.getAttribute('data-section-id');
          if (sectionId) {
            sectionsToBundle.push(sectionId);
          }
        }

        // Add to cart using fetch
        fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            id: variantId,
            quantity: quantity,
            sections: sectionsToBundle,
            sections_url: window.location.pathname
          })
        })
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(function(data) {
          if (data.status) {
            console.error('Add to cart error:', data.description || data.message);
            addToCartButton.removeAttribute('aria-disabled');
            addToCartButton.removeAttribute('aria-busy');
            return;
          }

          // Remove loading state after successful add
          addToCartButton.removeAttribute('aria-disabled');
          addToCartButton.removeAttribute('aria-busy');

          // Dispatch cart update event if theme is available
          if (typeof theme !== 'undefined' && theme.pubsub) {
            fetch('/cart.js')
              .then(function(response) {
                return response.json();
              })
              .then(function(cart) {
                // Merge sections from add to cart response into cart
                if (data.sections) {
                  cart.sections = data.sections;
                }
                theme.pubsub.publish(theme.pubsub.PUB_SUB_EVENTS.cartUpdate, {
                  source: 'ml-featured-product',
                  productVariantId: variantId,
                  cart: cart
                });

                // Show cart drawer after cart update
                const cartDrawerElement = document.querySelector('cart-drawer');
                if (cartDrawerElement) {
                  cartDrawerElement.show(addToCartButton);
                }
              });
          } else {
            // Show cart drawer if theme is not available
            const cartDrawerElement = document.querySelector('cart-drawer');
            if (cartDrawerElement) {
              cartDrawerElement.show(addToCartButton);
            }
          }

          // Dispatch custom event
          document.dispatchEvent(new CustomEvent('ajaxProduct:added', {
            detail: {
              product: data
            }
          }));
        })
        .catch(function(error) {
          console.error('Error adding to cart:', error);
          addToCartButton.removeAttribute('aria-disabled');
          addToCartButton.removeAttribute('aria-busy');
        });
      });

      // Initialize with default variant when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateVariantSelection);
      } else {
        updateVariantSelection();
      }
    })();
    {%- endif -%}
  })();
</script>

{% schema %}
{
  "name": "ML Featured Product",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "header",
      "content": "Featured Image"
    },
    {
      "type": "image_picker",
      "id": "featured_image",
      "label": "Featured Image"
    },
    {
      "type": "text",
      "id": "featured_image_text",
      "label": "Featured Image Text",
      "default": "SHOP FUEL JUGS"
    },
    {
      "type": "url",
      "id": "featured_image_link",
      "label": "Featured Image Link"
    },
    {
      "type": "range",
      "id": "featured_image_width",
      "min": 200,
      "max": 500,
      "step": 10,
      "unit": "px",
      "label": "Featured Image Width",
      "default": 300
    },
    {
      "type": "header",
      "content": "t:sections.global.settings.header__colors.content",
      "info": "t:sections.global.settings.header__colors.info"
    },
    {
      "type": "color",
      "id": "color_text",
      "label": "t:sections.global.settings.color_text.label"
    },
    {
      "type": "color",
      "id": "color_background",
      "label": "t:sections.global.settings.color_background.label"
    },
    {
      "type": "color_background",
      "id": "gradient_background",
      "label": "t:sections.global.settings.gradient_background.label"
    },
    {
      "type": "header",
      "content": "t:sections.global.settings.header__section.content"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "t:sections.global.settings.padding_top.label",
      "default": 72
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "t:sections.global.settings.padding_bottom.label",
      "default": 72
    },
    {
      "type": "header",
      "content": "Section Margins"
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    },
    {
      "type": "checkbox",
      "id": "divider",
      "label": "t:sections.global.settings.divider.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "t:sections.global.settings.full_width.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "rounded",
      "default": false,
      "label": "t:sections.global.settings.rounded.label"
    }
  ],
  "presets": [
    {
      "name": "ML Featured Product",
      "category": "Products"
    }
  ],
  "disabled_on": {
    "templates": [
      "password"
    ]
  }
}
{% endschema %}
