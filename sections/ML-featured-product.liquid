<style>
  #shopify-section-{{ section.id }} {
    --section-padding-top: {{ section.settings.padding_top }}px;
    --section-padding-bottom: {{ section.settings.padding_bottom }}px;
    margin-top: {{ section.settings.margin_top }}px;
    margin-bottom: {{ section.settings.margin_bottom }}px;
    {%- render 'section-variables', section: section -%}
  }

  @media screen and (min-width: 1024px) {
    .ml-featured-product__container {
      grid-template-columns: 1fr {{ section.settings.featured_image_width }}px;
      gap: 60px;
    }
  }
</style>

{%- liquid
  assign product = section.settings.product
  if product != blank
    assign product_form_id = 'MLProductForm-' | append: section.id | append: '-' | append: product.id
    assign media_count = product.media.size
    assign product_variant = product.selected_or_first_available_variant
    assign featured_media = product_variant.featured_media | default: product.featured_media
  endif
-%}

{%- if product.quantity_price_breaks_configured? -%}
  {{ 'volume-pricing.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'volume-pricing.js' | asset_url }}" defer="defer"></script>
{%- endif -%}

<div class="ml-featured-product section section--padding{% if section.settings.divider %} section--divider{% endif %}{% if section.settings.rounded %} section--rounded relative{% endif %}">
  <div class="relative">
    {%- if product != blank -%}
      <div class="ml-featured-product__container">
        <div class="ml-featured-product__content-wrapper">
          <div class="ml-featured-product__gallery">
          {%- if media_count > 0 -%}
            <media-gallery id="MLProductGallery-{{ section.id }}-{{ product.id }}" class="ml-featured-product__gallery-wrapper">
              <div class="ml-featured-product__main-image">
                <slider-element id="MLSliderGallery-{{ section.id }}-{{ product.id }}" class="slider slider--desktop slider--tablet block w-full h-full" selector=".ml-featured-product__media-item" tabindex="0">
                  <div class="ml-featured-product__media-list flex gap-0">
                    {%- if featured_media != null -%}
                      <div class="ml-featured-product__media-item w-full cursor-pointer" data-media-type="{{ featured_media.media_type }}" data-media-id="{{ featured_media.id }}" style="aspect-ratio: {{ featured_media.aspect_ratio }};">
                        {{- featured_media.preview_image | image_url: width: 1200 | image_tag: loading: 'eager', sizes: '50vw', widths: '375,550,750,1100,1500', alt: featured_media.alt | default: product.title, is: 'lazy-image', class: 'w-full h-full object-cover' -}}
                      </div>
                    {%- endif -%}
                    {%- for media in product.media -%}
                      {%- if media.id != featured_media.id -%}
                        <div class="ml-featured-product__media-item w-full cursor-pointer" data-media-type="{{ media.media_type }}" data-media-id="{{ media.id }}" style="aspect-ratio: {{ media.aspect_ratio }};">
                          {{- media.preview_image | image_url: width: 1200 | image_tag: loading: 'lazy', sizes: '50vw', widths: '375,550,750,1100,1500', alt: media.alt | default: product.title, is: 'lazy-image', class: 'w-full h-full object-cover' -}}
                        </div>
                      {%- endif -%}
                    {%- endfor -%}
                  </div>
                <div class="indicators hidden items-center justify-between opacity-0 z-1 absolute top-0 left-0 w-full h-full pointer-events-none">
                  <button class="ml-featured-product__gallery-nav ml-featured-product__gallery-nav--prev button button--secondary pointer-events-auto" type="button" is="previous-button" aria-controls="MLSliderGallery-{{ section.id }}-{{ product.id }}" aria-label="{{ 'general.pagination.previous' | t | escape }}" disabled>
                    <span class="btn-fill" data-fill></span>
                    <span class="btn-text">
                      {%- render 'icon', icon: 'chevron-left', class: 'transform' -%}
                    </span>
                  </button>
                  <button class="ml-featured-product__gallery-nav ml-featured-product__gallery-nav--next button button--secondary pointer-events-auto" type="button" is="next-button" aria-controls="MLSliderGallery-{{ section.id }}-{{ product.id }}" aria-label="{{ 'general.pagination.next' | t | escape }}">
                    <span class="btn-fill" data-fill></span>
                    <span class="btn-text">
                      {%- render 'icon', icon: 'chevron-right', class: 'transform' -%}
                    </span>
                  </button>
                </div>
              </slider-element>
              </div>
            </media-gallery>
            {%- if media_count > 1 -%}
              <div class="ml-featured-product__thumbnails" id="MLThumbnails-{{ section.id }}-{{ product.id }}">
                {%- if featured_media != null -%}
                  <button type="button" class="ml-featured-product__thumbnail active" data-media-id="{{ featured_media.id }}" aria-label="{{ 'general.accessibility.go_to_item' | t: index: 1 | escape }}">
                    {{- featured_media.preview_image | image_url: width: 160 | image_tag: loading: 'lazy', sizes: '80px', widths: '80,160', alt: featured_media.alt | default: product.title, is: 'lazy-image' -}}
                  </button>
                {%- endif -%}
                {%- for media in product.media -%}
                  {%- if media.id != featured_media.id -%}
                    <button type="button" class="ml-featured-product__thumbnail" data-media-id="{{ media.id }}" aria-label="{{ 'general.accessibility.go_to_item' | t: index: forloop.index | plus: 1 | escape }}">
                      {{- media.preview_image | image_url: width: 160 | image_tag: loading: 'lazy', sizes: '80px', widths: '80,160', alt: media.alt | default: product.title, is: 'lazy-image' -}}
                    </button>
                  {%- endif -%}
                {%- endfor -%}
              </div>
            {%- endif -%}
          {%- else -%}
            <div class="ml-featured-product__main-image">
              {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          {%- endif -%}
          </div>

          <div class="ml-featured-product__info">
          <h2 class="ml-featured-product__title">{{ product.title }}</h2>

          <div class="ml-featured-product__price">
            {%- liquid
              if settings.currency_code_enabled
                echo product.selected_or_first_available_variant.price | money_with_currency
              else
                echo product.selected_or_first_available_variant.price | money
              endif
            -%}
          </div>

          {%- if product.description != blank -%}
            <div class="ml-featured-product__description rte">
              {{ product.description }}
            </div>
          {%- endif -%}

          {%- form 'product', product, id: product_form_id, class: 'ml-featured-product__form', is: 'product-form' -%}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" disabled />

            {%- unless product.has_only_default_variant -%}
              <div class="ml-featured-product__variant-selector">
                {%- for option in product.options_with_values -%}
                  <div class="ml-featured-product__variant-option">
                    <label class="ml-featured-product__variant-label">
                      Select {{ option.name }}:
                      <span class="ml-featured-product__variant-selected">{{ option.selected_value }}</span>
                    </label>
                    <div class="ml-featured-product__variant-values">
                      {%- for value in option.values -%}
                        {%- assign variant_available = false -%}
                        {%- assign variant_id = null -%}
                        {%- for variant in product.variants -%}
                          {%- if variant.options[forloop.parentloop.index0] == value -%}
                            {%- if variant.available -%}
                              {%- assign variant_available = true -%}
                              {%- assign variant_id = variant.id -%}
                              {%- break -%}
                            {%- endif -%}
                          {%- endif -%}
                        {%- endfor -%}
                        {%- assign is_selected = false -%}
                        {%- if product.selected_or_first_available_variant.options[forloop.parentloop.index0] == value -%}
                          {%- assign is_selected = true -%}
                        {%- endif -%}
                        <button
                          type="button"
                          class="ml-featured-product__variant-value{% if is_selected %} selected{% endif %}{% unless variant_available %} unavailable{% endunless %}"
                          data-option-index="{{ forloop.parentloop.index0 }}"
                          data-option-value="{{ value | escape }}"
                          {% unless variant_available %}disabled{% endunless %}
                        >
                          {{ value }}
                        </button>
                      {%- endfor -%}
                    </div>
                  </div>
                {%- endfor -%}
              </div>
            {%- endunless -%}

            <div class="ml-featured-product__quantity-cart">
              {%- assign cart_qty = cart | item_count_for_variant: product.selected_or_first_available_variant.id -%}
              <quantity-input class="ml-featured-product__quantity inline-flex relative" data-section-id="{{ section.id }}" data-product-id="{{ product.id }}">
                <button type="button" name="minus" class="ml-featured-product__quantity-button" aria-label="{{ 'products.quantity.decrease' | t: product: product.title | escape }}">
                  {%- render 'icon', icon: 'chevron-left', size: 'sm', class: 'stroke-2 transform' -%}
                </button>
                <input
                  type="number"
                  name="quantity"
                  id="MLQuantity-{{ section.id }}-{{ product.id }}"
                  class="ml-featured-product__quantity-input"
                  inputmode="numeric"
                  autocomplete="off"
                  data-quantity-variant-id="{{ product.selected_or_first_available_variant.id }}"
                  data-cart-quantity="{{ cart_qty }}"
                  data-min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                  min="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                  {% if product.selected_or_first_available_variant.quantity_rule.max != null %}
                    data-max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                    max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                  {% endif %}
                  step="{{ product.selected_or_first_available_variant.quantity_rule.increment }}"
                  value="{{ product.selected_or_first_available_variant.quantity_rule.min }}"
                  form="{{ product_form_id }}"
                />
                <button type="button" name="plus" class="ml-featured-product__quantity-button" aria-label="{{ 'products.quantity.increase' | t: product: product.title | escape }}">
                  {%- render 'icon', icon: 'chevron-right', size: 'sm', class: 'stroke-2 transform' -%}
                </button>
              </quantity-input>
              <button
                type="submit"
                name="add"
                form="{{ product_form_id }}"
                class="button ml-featured-product__add-to-cart"
                is="hover-button"
                {%- if product.selected_or_first_available_variant.available == false %} disabled{% endif -%}
              >
                <span class="btn-fill" data-fill></span>
                <span class="btn-text">
                  {%- liquid
                    if product.selected_or_first_available_variant.available == false
                      echo 'products.product.sold_out' | t
                    else
                      echo 'products.product.add_to_cart' | t
                    endif
                  -%}
                </span>
              </button>
            </div>
          {%- endform -%}
          </div>
        </div>

        {%- if section.settings.featured_image != blank -%}
          {%- if section.settings.featured_image_link != blank -%}
            <a href="{{ section.settings.featured_image_link }}" class="ml-featured-product__featured-image" aria-label="{{ section.settings.featured_image_text | default: 'Featured image' | escape }}">
          {%- else -%}
            <div class="ml-featured-product__featured-image">
          {%- endif -%}
            {{- section.settings.featured_image | image_url: width: 600 | image_tag: loading: 'lazy', sizes: '300px', widths: '300,600,900', alt: section.settings.featured_image_text, is: 'lazy-image', class: 'w-full h-full object-cover' -}}
            {%- if section.settings.featured_image_text != blank -%}
              <div class="ml-featured-product__featured-image-content">
                <div class="ml-featured-product__featured-image-text">
                  {{ section.settings.featured_image_text | escape }}
                  {%- render 'icon', icon: 'arrow-right', class: 'transform' -%}
                </div>
              </div>
            {%- endif -%}
          {%- if section.settings.featured_image_link != blank -%}
            </a>
          {%- else -%}
            </div>
          {%- endif -%}
        {%- endif -%}
      </div>
    {%- else -%}
      <div class="ml-featured-product__container">
        <div class="ml-featured-product__content-wrapper">
          <div class="ml-featured-product__gallery">
            <div class="ml-featured-product__main-image">
              {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          </div>
          <div class="ml-featured-product__info">
            <h2 class="ml-featured-product__title">{{ 'sections.featured_product.title' | t }}</h2>
            <p>{{ 'sections.featured_product.no_product' | t }}</p>
          </div>
        </div>
      </div>
    {%- endif -%}
  </div>
</div>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const productId = '{{ product.id }}';
    const formId = 'MLProductForm-' + sectionId + '-' + productId;
    const galleryId = 'MLSliderGallery-' + sectionId + '-' + productId;
    const thumbnailsId = 'MLThumbnails-' + sectionId + '-' + productId;
    const mediaGalleryId = 'MLProductGallery-' + sectionId + '-' + productId;

    {%- if product != blank -%}
    const productData = {{ product | json }};
    const form = document.getElementById(formId);
    const gallery = document.getElementById(galleryId);
    const thumbnails = document.getElementById(thumbnailsId);
    const mediaGallery = document.getElementById(mediaGalleryId);

    // Initialize PhotoSwipe lightbox for image zoom
    function initPhotoSwipe() {
      if (!mediaGallery || typeof PhotoSwipeLightbox === 'undefined' || typeof theme === 'undefined' || !theme.settings) {
        return;
      }

      let photoswipeLightbox = null;
      photoswipeLightbox = new PhotoSwipeLightbox({
        arrowPrevSVG: '<svg class="pswp__icn icon" stroke="currentColor" fill="none" viewBox="0 0 30 30"><path d="M17.5 7.5L10 15L17.5 22.5"/></svg>',
        arrowNextSVG: '<svg class="pswp__icn icon" stroke="currentColor" fill="none" viewBox="0 0 30 30"><path d="M17.5 7.5L10 15L17.5 22.5"/></svg>',
        closeSVG: '<svg class="pswp__icn icon" stroke="currentColor" fill="none" viewBox="0 0 30 30"><path d="m7.5 22.5 15-15m-15 0 15 15"/></svg>',
        bgOpacity: 1,
        pswpModule: () => import(theme.settings.pswpModule),
        arrowPrevTitle: theme.strings ? theme.strings.previous : 'Previous',
        arrowNextTitle: theme.strings ? theme.strings.next : 'Next',
        closeTitle: theme.strings ? theme.strings.close : 'Close',
        allowPanToNext: false,
        allowMouseDrag: true,
        wheelToZoom: false,
        returnFocus: true,
        zoom: false,
      });

      photoswipeLightbox.addFilter('thumbEl', (_thumbEl, data) => data['thumbnailElement']);
      photoswipeLightbox.init();

      // Add click handlers to media items
      const mediaItems = gallery.querySelectorAll('.ml-featured-product__media-item');
      mediaItems.forEach(function(item, index) {
        if (item.getAttribute('data-media-type') === 'image') {
          item.style.cursor = 'pointer';
          item.addEventListener('click', function() {
            const dataSource = Array.from(mediaItems).map(function(media) {
              const image = media.querySelector('img');
              if (image && media.getAttribute('data-media-type') === 'image') {
                return {
                  thumbnailElement: image,
                  src: image.src,
                  srcset: image.srcset || '',
                  msrc: image.currentSrc || image.src,
                  width: parseInt(image.getAttribute('width')) || image.naturalWidth || 1200,
                  height: parseInt(image.getAttribute('height')) || image.naturalHeight || 1200,
                  alt: image.alt || '',
                  thumbCropped: true
                };
              }
              return null;
            }).filter(function(item) { return item !== null; });

            if (photoswipeLightbox && dataSource.length > 0) {
              photoswipeLightbox.loadAndOpen(index, dataSource);
            }
          });
        }
      });
    }

    // Wait for PhotoSwipe to be available
    if (typeof PhotoSwipeLightbox === 'undefined') {
      // Try to initialize after a short delay
      setTimeout(initPhotoSwipe, 500);
    } else {
      initPhotoSwipe();
    }

    if (thumbnails) {
      const thumbnailButtons = thumbnails.querySelectorAll('.ml-featured-product__thumbnail');
      thumbnailButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          const mediaId = this.dataset.mediaId;
          const mediaItems = gallery.querySelectorAll('.ml-featured-product__media-item');

          thumbnailButtons.forEach(function(btn) {
            btn.classList.remove('active');
          });
          this.classList.add('active');

          mediaItems.forEach(function(item) {
            if (item.dataset.mediaId === mediaId) {
              item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
          });
        });
      });
    }

    if (form) {
      const variantButtons = form.querySelectorAll('.ml-featured-product__variant-value');
      const variantInput = form.querySelector('input[name="id"]');
      const quantityInput = form.querySelector('input[name="quantity"]');
      const addToCartButton = form.querySelector('.ml-featured-product__add-to-cart');

      variantButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          if (this.classList.contains('unavailable')) return;

          const optionIndex = parseInt(this.dataset.optionIndex);
          const optionValue = this.dataset.optionValue;

          const optionGroup = this.closest('.ml-featured-product__variant-option');
          const buttonsInGroup = optionGroup.querySelectorAll('.ml-featured-product__variant-value');
          const variantLabel = optionGroup.querySelector('.ml-featured-product__variant-label');
          const variantSelected = optionGroup.querySelector('.ml-featured-product__variant-selected');

          buttonsInGroup.forEach(function(btn) {
            btn.classList.remove('selected');
          });
          this.classList.add('selected');

          if (variantSelected) {
            variantSelected.textContent = optionValue;
          }

          const selectedOptions = [];
          const variantOptions = form.querySelectorAll('.ml-featured-product__variant-option');
          variantOptions.forEach(function(optionGroup) {
            const selectedButton = optionGroup.querySelector('.ml-featured-product__variant-value.selected');
            if (selectedButton) {
              selectedOptions.push(selectedButton.dataset.optionValue);
            }
          });

          const matchingVariant = productData.variants.find(function(variant) {
            return variant.options.every(function(option, index) {
              return selectedOptions[index] === option;
            });
          });

          if (matchingVariant) {
            variantInput.value = matchingVariant.id;
            variantInput.disabled = false;

            const priceElement = document.querySelector('.ml-featured-product__price');
            if (priceElement) {
              {%- if settings.currency_code_enabled -%}
                priceElement.textContent = new Intl.NumberFormat('{{ localization.country.currency.iso_code }}', {
                  style: 'currency',
                  currency: '{{ cart.currency.iso_code }}'
                }).format(matchingVariant.price / 100);
              {%- else -%}
                const formatter = new Intl.NumberFormat('{{ localization.country.currency.iso_code }}', {
                  style: 'currency',
                  currency: '{{ cart.currency.iso_code }}',
                  minimumFractionDigits: 2
                });
                priceElement.textContent = formatter.format(matchingVariant.price / 100);
              {%- endif -%}
            }

            if (addToCartButton) {
              addToCartButton.disabled = !matchingVariant.available;
              const btnText = addToCartButton.querySelector('.btn-text');
              if (btnText) {
                if (!matchingVariant.available) {
                  btnText.textContent = '{{ 'products.product.sold_out' | t }}';
                } else {
                  btnText.textContent = '{{ 'products.product.add_to_cart' | t }}';
                }
              }
            }

            if (quantityInput) {
              quantityInput.setAttribute('data-quantity-variant-id', matchingVariant.id);
              quantityInput.setAttribute('data-min', matchingVariant.quantity_rule ? matchingVariant.quantity_rule.min : 1);
              quantityInput.setAttribute('min', matchingVariant.quantity_rule ? matchingVariant.quantity_rule.min : 1);
              if (matchingVariant.quantity_rule && matchingVariant.quantity_rule.max != null) {
                quantityInput.setAttribute('data-max', matchingVariant.quantity_rule.max);
                quantityInput.setAttribute('max', matchingVariant.quantity_rule.max);
              } else {
                quantityInput.removeAttribute('data-max');
                quantityInput.removeAttribute('max');
              }
              if (matchingVariant.quantity_rule) {
                quantityInput.setAttribute('step', matchingVariant.quantity_rule.increment);
                quantityInput.value = matchingVariant.quantity_rule.min;
              }
            }

            const mediaId = matchingVariant.featured_media ? matchingVariant.featured_media.id : null;
            if (mediaId && gallery) {
              const mediaItems = gallery.querySelectorAll('.ml-featured-product__media-item');
              mediaItems.forEach(function(item) {
                if (item.dataset.mediaId === mediaId.toString()) {
                  item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                  if (thumbnails) {
                    const thumbnailButtons = thumbnails.querySelectorAll('.ml-featured-product__thumbnail');
                    thumbnailButtons.forEach(function(btn) {
                      btn.classList.remove('active');
                      if (btn.dataset.mediaId === mediaId.toString()) {
                        btn.classList.add('active');
                      }
                    });
                  }
                }
              });
            }
          }
        });
      });
    }
    {%- endif -%}
  })();
</script>

{% schema %}
{
  "name": "ML Featured Product",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "header",
      "content": "Featured Image"
    },
    {
      "type": "image_picker",
      "id": "featured_image",
      "label": "Featured Image"
    },
    {
      "type": "text",
      "id": "featured_image_text",
      "label": "Featured Image Text",
      "default": "SHOP FUEL JUGS"
    },
    {
      "type": "url",
      "id": "featured_image_link",
      "label": "Featured Image Link"
    },
    {
      "type": "range",
      "id": "featured_image_width",
      "min": 200,
      "max": 500,
      "step": 10,
      "unit": "px",
      "label": "Featured Image Width",
      "default": 300
    },
    {
      "type": "header",
      "content": "t:sections.global.settings.header__colors.content",
      "info": "t:sections.global.settings.header__colors.info"
    },
    {
      "type": "color",
      "id": "color_text",
      "label": "t:sections.global.settings.color_text.label"
    },
    {
      "type": "color",
      "id": "color_background",
      "label": "t:sections.global.settings.color_background.label"
    },
    {
      "type": "color_background",
      "id": "gradient_background",
      "label": "t:sections.global.settings.gradient_background.label"
    },
    {
      "type": "header",
      "content": "t:sections.global.settings.header__section.content"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "t:sections.global.settings.padding_top.label",
      "default": 72
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 120,
      "step": 4,
      "unit": "px",
      "label": "t:sections.global.settings.padding_bottom.label",
      "default": 72
    },
    {
      "type": "header",
      "content": "Section Margins"
    },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    },
    {
      "type": "checkbox",
      "id": "divider",
      "label": "t:sections.global.settings.divider.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "t:sections.global.settings.full_width.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "rounded",
      "default": false,
      "label": "t:sections.global.settings.rounded.label"
    }
  ],
  "presets": [
    {
      "name": "ML Featured Product",
      "category": "Products"
    }
  ],
  "disabled_on": {
    "templates": [
      "password"
    ]
  }
}
{% endschema %}
